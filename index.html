<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIPMINI INSTITUTE</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .content {
            padding: 20px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .display-box {
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 15px;
            font-size: 28px;
            text-align: center;
            margin-bottom: 15px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #333;
        }

        .keyboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .key-btn {
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
        }

        .key-btn:active {
            transform: scale(0.95);
            background: #667eea;
            color: white;
        }

        .action-btns {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
        }

        .btn-ok {
            background: #28a745;
            color: white;
        }

        .btn-dollar {
            background: #ffc107;
            color: #000;
            font-size: 20px;
        }

        .btn-clear {
            background: #6c757d;
            color: white;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #667eea;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .modal-content {
            margin-bottom: 20px;
        }

        .subject-card {
            background: #f8f9fa;
            border: 3px solid #dee2e6;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .subject-card:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .subject-card:active {
            transform: scale(0.98);
        }

        .subject-card.selected {
            border-color: #667eea;
            background: #e7e9ff;
        }

        .subject-number {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            text-align: center;
            line-height: 35px;
            font-weight: bold;
            font-size: 18px;
            margin-right: 10px;
        }

        .subject-info {
            display: inline-block;
            vertical-align: middle;
            width: calc(100% - 50px);
        }

        .subject-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            display: block;
        }

        .subject-teacher {
            font-size: 14px;
            color: #666;
            margin-top: 2px;
            display: block;
        }

        .subject-payment {
            font-size: 13px;
            margin-top: 5px;
            display: block;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            align-items: center;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: bold;
            color: #495057;
            flex: 1;
        }

        .info-value {
            color: #212529;
            text-align: right;
            flex: 1;
        }

        .payment-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
        }

        .status-unpaid {
            background: #f8d7da;
            color: #721c24;
        }

        .status-partial {
            background: #fff3cd;
            color: #856404;
        }

        .balance-alert {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }

        .balance-alert.negative {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .balance-alert.positive {
            background: #d1ecf1;
            border-color: #17a2b8;
        }

        .balance-amount {
            font-size: 24px;
            font-weight: bold;
            margin-top: 5px;
        }

        .btn-modal-ok {
            background: #667eea;
            color: white;
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .btn-modal-ok:active {
            transform: scale(0.95);
            background: #5568d3;
        }

        .btn-payment {
            background: #dc3545;
            color: white;
            width: 100%;
            margin-top: 15px;
            padding: 18px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        .payment-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .payment-display {
            background: white;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 15px;
            font-size: 24px;
            text-align: center;
            margin-bottom: 15px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #28a745;
        }

        .payment-keyboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .payment-key-btn {
            background: white;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 15px;
            font-size: 20px;
            font-weight: bold;
            color: #28a745;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
        }

        .payment-key-btn:active {
            transform: scale(0.95);
            background: #28a745;
            color: white;
        }

        .btn-confirm-payment {
            background: #ffc107;
            color: #000;
            width: 100%;
            padding: 18px;
            font-size: 22px;
            font-weight: bold;
            margin-top: 10px;
            border: 3px solid #000;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-confirm-payment:active {
            transform: scale(0.95);
            background: #ffb300;
        }

        .error-modal .modal-header h2 {
            color: #dc3545;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .success-icon {
            font-size: 48px;
            margin-bottom: 10px;
            color: #28a745;
        }

        .debug-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 12px;
            color: #666;
            word-wrap: break-word;
        }

        .btn-back {
            background: #6c757d;
            color: white;
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }

        .payment-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
            color: #856404;
        }

        .payment-warning.excess {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }

        .payment-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-option {
            padding: 12px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-option:active {
            transform: scale(0.95);
            background: #667eea;
            color: white;
        }

        .btn-option.selected {
            background: #667eea;
            color: white;
        }

        .attendance-note {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
            color: #0c5460;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì SIPMINI INSTITUTE</h1>
            <p>Student Management System</p>
        </div>

        <div class="content">
            <div class="input-section">
                <div class="display-box" id="display"></div>
                
                <div class="keyboard">
                    <button class="key-btn" onclick="addDigit('1')">1</button>
                    <button class="key-btn" onclick="addDigit('2')">2</button>
                    <button class="key-btn" onclick="addDigit('3')">3</button>
                    <button class="key-btn" onclick="addDigit('4')">4</button>
                    <button class="key-btn" onclick="addDigit('5')">5</button>
                    <button class="key-btn" onclick="addDigit('6')">6</button>
                    <button class="key-btn" onclick="addDigit('7')">7</button>
                    <button class="key-btn" onclick="addDigit('8')">8</button>
                    <button class="key-btn" onclick="addDigit('9')">9</button>
                    <button class="key-btn btn-dollar" onclick="addDigit('$')">üíµ $</button>
                    <button class="key-btn" onclick="addDigit('0')">0</button>
                    <button class="key-btn" onclick="backspace()" style="background: #dc3545; color: white;">‚å´</button>
                </div>

                <div class="action-btns">
                    <button class="btn btn-ok" onclick="handleOK()">‚úì OK</button>
                    <button class="btn btn-clear" onclick="clearDisplay()">Clear</button>
                </div>
            </div>
        </div>
    </div>

    <div id="subjectModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>‡∂¥‡∂±‡∑ä‡∂≠‡∑í‡∂∫ ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±</h2>
                <p id="studentNameHeader" style="color: #666; font-size: 16px; margin-top: 5px;"></p>
            </div>
            <div class="attendance-note">
                ‚úÖ ‡∂¥‡∑ê‡∂∏‡∑í‡∂´‡∑ì‡∂∏ ‡∑É‡∑ä‡∑Ä‡∂∫‡∂Ç‡∂ö‡∑ä‚Äç‡∂ª‡∑ì‡∂∫‡∑Ä ‡∑É‡∂ß‡∑Ñ‡∂±‡∑ä ‡∂ö‡∂ª ‡∂á‡∂≠
            </div>
            <div class="modal-content" id="subjectList"></div>
            <button class="btn-back" onclick="closeSubjectModal()">‚óÑ ‡∂Ü‡∂¥‡∑É‡∑î</button>
        </div>
    </div>

    <div id="errorModal" class="modal-overlay">
        <div class="modal error-modal">
            <div class="modal-header">
                <div class="error-icon">‚ö†Ô∏è</div>
                <h2>‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑í</h2>
            </div>
            <div class="modal-content">
                <p id="errorMessage" style="text-align: center; font-size: 16px; color: #721c24;"></p>
                <div id="debugInfo" class="debug-info" style="display: none;"></div>
            </div>
            <button class="btn-modal-ok" onclick="closeErrorModal()">OK</button>
        </div>
    </div>

    <div id="studentModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>‡∑Å‡∑í‡∑Ç‡∑ä‚Äç‡∂∫ ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä</h2>
            </div>
            <div class="modal-content">
                <div class="attendance-note">
                    ‚úÖ ‡∂¥‡∑ê‡∂∏‡∑í‡∂´‡∑ì‡∂∏ ‡∑É‡∂ß‡∑Ñ‡∂±‡∑ä ‡∂ö‡∂ª ‡∂á‡∂≠
                </div>
                
                <div id="balanceAlert"></div>
                
                <div class="info-row">
                    <span class="info-label">‡∂±‡∂∏:</span>
                    <span class="info-value" id="studentName"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">‡∑Ä‡∑í‡∑Ç‡∂∫:</span>
                    <span class="info-value" id="subject"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">‡∂ú‡∑î‡∂ª‡∑î‡∑Ä‡∂ª‡∂∫‡∑è:</span>
                    <span class="info-value" id="teacherName"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">‡∂∏‡∑è‡∑É‡∑í‡∂ö ‡∂ú‡∑è‡∑É‡∑ä‡∂≠‡∑î‡∑Ä:</span>
                    <span class="info-value" id="monthlyFee"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">‡∂∏‡∑ô‡∂∏ ‡∂∏‡∑è‡∑É‡∂∫‡∑ö ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä:</span>
                    <span class="info-value" id="paymentStatus"></span>
                </div>

                <button class="btn btn-payment" onclick="showPaymentSection()">üí∞ ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏ ‡∑É‡∂ß‡∑Ñ‡∂±‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>

                <div id="paymentSection" class="payment-section" style="display: none;">
                    <h3 style="text-align: center; margin-bottom: 15px; color: #28a745;">‡∂ú‡∑ô‡∑Ä‡∂± ‡∂∏‡∑î‡∂Ø‡∂Ω ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</h3>
                    
                    <div id="paymentWarning"></div>
                    
                    <div class="payment-display" id="paymentDisplay">0</div>
                    
                    <div class="payment-keyboard">
                        <button class="payment-key-btn" onclick="addPaymentDigit('1')">1</button>
                        <button class="payment-key-btn" onclick="addPaymentDigit('2')">2</button>
                        <button class="payment-key-btn" onclick="addPaymentDigit('3')">3</button>
                        <button class="payment-key-btn" onclick="addPaymentDigit('4')">4</button>
                        <button class="payment-key-btn" onclick="addPaymentDigit('5')">5</button>
                        <button class="payment-key-btn" onclick="addPaymentDigit('6')">6</button>
                        <button class="payment-key-btn" onclick="addPaymentDigit('7')">7</button>
                        <button class="payment-key-btn" onclick="addPaymentDigit('8')">8</button>
                        <button class="payment-key-btn" onclick="addPaymentDigit('9')">9</button>
                        <button class="payment-key-btn" onclick="clearPaymentDisplay()">C</button>
                        <button class="payment-key-btn" onclick="addPaymentDigit('0')">0</button>
                        <button class="payment-key-btn" onclick="paymentBackspace()" style="background: #dc3545; color: white; border-color: #dc3545;">‚å´</button>
                    </div>

                    <button class="btn-confirm-payment" onclick="processPayment()">üíµ $ ‡∂≠‡∑Ñ‡∑Ä‡∑î‡∂ª‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
                    
                    <div id="paymentOptions" style="display: none;">
                        <div class="payment-options">
                            <button class="btn-option" onclick="selectPaymentOption('accept')">‡∂∑‡∑è‡∂ª‡∂ú‡∂±‡∑ä‡∂±</button>
                            <button class="btn-option" onclick="selectPaymentOption('edit')">‡∑É‡∂Ç‡∑É‡∑ä‡∂ö‡∂ª‡∂´‡∂∫</button>
                        </div>
                    </div>
                </div>
            </div>
            <button class="btn-modal-ok" onclick="closeStudentModal()">OK</button>
        </div>
    </div>

    <div id="successModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="success-icon">‚úì</div>
                <h2>‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í</h2>
            </div>
            <div class="modal-content">
                <p id="successMessage" style="text-align: center; font-size: 16px; color: #155724;"></p>
            </div>
            <button class="btn-modal-ok" onclick="closeSuccessModal()">OK</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://uqgzlaxsnknheoerbfus.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxZ3psYXhzbmtuaGVvZXJiZnVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ4MDQzMTEsImV4cCI6MjA2MDM4MDMxMX0.O5dNUizqZ5kfwTs0mHLEorqOAqjZFjWakp2Q484MKEk';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentDisplay = '';
        let currentStudent = null;
        let paymentAmount = '0';
        let paymentMode = false;
        let availableSubjects = [];
        let pendingPaymentData = null;

        function addDigit(digit) {
            if (digit === '$') {
                paymentMode = true;
                currentDisplay = '';
                document.getElementById('display').textContent = '$';
                return;
            }
            
            if (paymentMode) {
                currentDisplay += digit;
                document.getElementById('display').textContent = '$' + currentDisplay;
            } else {
                currentDisplay += digit;
                document.getElementById('display').textContent = currentDisplay;
            }
        }

        function backspace() {
            currentDisplay = currentDisplay.slice(0, -1);
            if (paymentMode) {
                document.getElementById('display').textContent = '$' + currentDisplay;
            } else {
                document.getElementById('display').textContent = currentDisplay;
            }
        }

        function clearDisplay() {
            currentDisplay = '';
            paymentMode = false;
            document.getElementById('display').textContent = '';
        }

        function addPaymentDigit(digit) {
            if (paymentAmount === '0') {
                paymentAmount = digit;
            } else {
                paymentAmount += digit;
            }
            document.getElementById('paymentDisplay').textContent = paymentAmount;
            updatePaymentWarning();
        }

        function paymentBackspace() {
            paymentAmount = paymentAmount.slice(0, -1);
            if (paymentAmount === '') {
                paymentAmount = '0';
            }
            document.getElementById('paymentDisplay').textContent = paymentAmount;
            updatePaymentWarning();
        }

        function clearPaymentDisplay() {
            paymentAmount = '0';
            document.getElementById('paymentDisplay').textContent = paymentAmount;
            document.getElementById('paymentWarning').innerHTML = '';
            document.getElementById('paymentOptions').style.display = 'none';
        }

        function showErrorModal(message, debugData = null) {
            document.getElementById('errorMessage').textContent = message;
            const debugDiv = document.getElementById('debugInfo');
            if (debugData) {
                debugDiv.style.display = 'block';
                debugDiv.textContent = 'Debug: ' + JSON.stringify(debugData, null, 2);
            } else {
                debugDiv.style.display = 'none';
            }
            document.getElementById('errorModal').classList.add('show');
        }

        function closeErrorModal() {
            document.getElementById('errorModal').classList.remove('show');
        }

        function closeSubjectModal() {
            document.getElementById('subjectModal').classList.remove('show');
            clearDisplay();
        }

        function closeStudentModal() {
            document.getElementById('studentModal').classList.remove('show');
            document.getElementById('paymentSection').style.display = 'none';
            paymentAmount = '0';
            document.getElementById('paymentDisplay').textContent = '0';
            document.getElementById('paymentWarning').innerHTML = '';
            document.getElementById('paymentOptions').style.display = 'none';
            pendingPaymentData = null;
            clearDisplay();
        }

        function showSuccessModal(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successModal').classList.add('show');
        }

        function closeSuccessModal() {
            document.getElementById('successModal').classList.remove('show');
        }

        function formatStudentNo(input) {
            input = input.padStart(4, '0');
            return 's' + input;
        }

        function formatDate(date) {
            const d = new Date(date);
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${d.getDate()}/${months[d.getMonth()]}/${d.getFullYear()}`;
        }

        function calculateBalance(student) {
            const monthlyFee = student.monthly_fee;
            
            if (monthlyFee === null || monthlyFee === undefined || monthlyFee === 0) {
                return { balance: 0, type: 'free', months: 0, unpaidAmount: 0, overpaidAmount: 0 };
            }

            if (!student.sreport || student.sreport.trim() === '' || student.sreport === 'EMPTY') {
                return { balance: 0, type: 'zero', months: 0, unpaidAmount: 0, overpaidAmount: 0 };
            }

            const payments = student.payment ? student.payment.split(',').map(p => p.trim()).filter(p => p) : [];
            
            // ‡∂ú‡∑ô‡∑Ä‡∑ñ ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∑É‡∑Ñ ‡∂∏‡∑è‡∑É ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫
            const paidMonths = {};
            let totalPaid = 0;
            
            payments.forEach(p => {
                const match = p.match(/(\d+)\/(\w+)\/(\d+)-(\d+(?:\.\d+)?)/);
                if (match) {
                    const [, day, month, year, amount] = match;
                    const monthKey = `${year}-${month.toLowerCase()}`;
                    if (!paidMonths[monthKey]) {
                        paidMonths[monthKey] = 0;
                    }
                    paidMonths[monthKey] += parseFloat(amount);
                    totalPaid += parseFloat(amount);
                }
            });

            // ‡∂¥‡∑ê‡∂∏‡∑í‡∂´‡∑ì‡∂∏‡∑ä ‡∂á‡∂≠‡∑í ‡∂∏‡∑è‡∑É ‡∑Ñ‡∂≥‡∑î‡∂±‡∑è‡∂ú‡∂±‡∑ä‡∂±
            const sreportDates = student.sreport.split(',').map(d => d.trim()).filter(d => d);
            const attendedMonths = new Set();
            
            sreportDates.forEach(dateStr => {
                const match = dateStr.match(/(\d+)\/(\w+)\/(\d+)/);
                if (match) {
                    const [, day, month, year] = match;
                    attendedMonths.add(`${year}-${month.toLowerCase()}`);
                }
            });

            // ‡∑Ñ‡∑í‡∂ü ‡∂∏‡∑î‡∂Ø‡∂Ω ‡∂ú‡∂´‡∂±‡∂∫
            let totalDue = 0;
            let unpaidMonths = 0;
            
            attendedMonths.forEach(monthKey => {
                const paidForMonth = paidMonths[monthKey] || 0;
                if (paidForMonth < monthlyFee) {
                    totalDue += (monthlyFee - paidForMonth);
                    unpaidMonths++;
                }
            });

            const balance = totalPaid - (attendedMonths.size * monthlyFee);

            return {
                balance: balance,
                type: balance < 0 ? 'negative' : (balance > 0 ? 'positive' : 'zero'),
                months: unpaidMonths,
                unpaidAmount: Math.abs(Math.min(balance, 0)),
                overpaidAmount: Math.max(balance, 0)
            };
        }

        function checkCurrentMonthPayment(payment, monthlyFee) {
            if (monthlyFee === null || monthlyFee === undefined || monthlyFee === 0) {
                return { status: 'FREE CARD', paid: true, canPay: false, paidAmount: 0 };
            }
            
            const now = new Date();
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const currentMonthKey = `${now.getFullYear()}-${monthNames[now.getMonth()].toLowerCase()}`;
            
            const payments = payment ? payment.split(',').map(p => p.trim()).filter(p => p) : [];
            
            let paidAmount = 0;
            payments.forEach(p => {
                const match = p.match(/(\d+)\/(\w+)\/(\d+)-(\d+(?:\.\d+)?)/);
                if (match) {
                    const [, day, month, year, amount] = match;
                    const monthKey = `${year}-${month.toLowerCase()}`;
                    if (monthKey === currentMonthKey) {
                        paidAmount += parseFloat(amount);
                    }
                }
            });

            if (paidAmount >= monthlyFee) {
                return { status: '‡∂ú‡∑ô‡∑Ä‡∑è ‡∂á‡∂≠', paid: true, canPay: false, paidAmount: paidAmount };
            } else if (paidAmount > 0) {
                const shortage = monthlyFee - paidAmount;
                return { status: `‡∂Ö‡∂©‡∑î Rs. ${shortage}`, paid: false, canPay: true, paidAmount: paidAmount };
            } else {
                return { status: '‡∂ú‡∑ô‡∑Ä‡∑è ‡∂±‡∑ê‡∂≠', paid: false, canPay: true, paidAmount: 0 };
            }
        }

        async function handleOK() {
            if (currentDisplay === '') {
                showErrorModal('‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑Å‡∑í‡∑Ç‡∑ä‚Äç‡∂∫ ‡∂Ö‡∂Ç‡∂ö‡∂∫‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±');
                return;
            }

            if (paymentMode) {
                await processDirectPayment();
                return;
            }

            const studentNo = formatStudentNo(currentDisplay);
            
            try {
                const { data, error } = await supabase
                    .from('sipminireport')
                    .select('*')
                    .eq('studentno', studentNo);

                if (error) {
                    showErrorModal('Database ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä: ' + error.message, error);
                    return;
                }

                if (!data || data.length === 0) {
                    showErrorModal('‡∑Å‡∑í‡∑Ç‡∑ä‚Äç‡∂∫‡∂∫‡∑è ‡∑Ñ‡∂∏‡∑î ‡∂±‡∑ú‡∑Ä‡∑î‡∂´‡∑í. ‡∂Ö‡∂Ç‡∂ö‡∂∫: ' + studentNo);
                    return;
                }

                // ‡∂¥‡∑ê‡∂∏‡∑í‡∂´‡∑ì‡∂∏ ‡∑É‡∂ß‡∑Ñ‡∂±‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
                const now = new Date();
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const newAttendance = `${now.getDate()}/${monthNames[now.getMonth()]}/${now.getFullYear()}`;

                for (const student of data) {
                    let updatedSreport = student.sreport || '';
                    if (updatedSreport && updatedSreport !== 'EMPTY') {
                        updatedSreport += ', ' + newAttendance;
                    } else {
                        updatedSreport = newAttendance;
                    }

                    const { error: updateError } = await supabase
                        .from('sipminireport')
                        .update({ sreport: updatedSreport })
                        .eq('id', student.id);

                    if (updateError) {
                        console.error('Error updating attendance:', updateError);
                    }
                }

                if (data.length === 1) {
                    currentStudent = data[0];
                    currentStudent.sreport = (currentStudent.sreport || '') + (currentStudent.sreport && currentStudent.sreport !== 'EMPTY' ? ', ' : '') + newAttendance;
                    showStudentDetails();
                } else {
                    availableSubjects = data.map(s => ({
                        ...s,
                        sreport: (s.sreport || '') + (s.sreport && s.sreport !== 'EMPTY' ? ', ' : '') + newAttendance
                    }));
                    showSubjectSelection(availableSubjects);
                }
            } catch (error) {
                showErrorModal('‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∑ö‡∂Ø‡∑ì ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‡∑É‡∑í‡∂Ø‡∑î‡∑Ä‡∑í‡∂∫', error);
            }
        }

        function showSubjectSelection(subjects) {
            document.getElementById('studentNameHeader').textContent = `‡∑Å‡∑í‡∑Ç‡∑ä‚Äç‡∂∫‡∂∫‡∑è: ${subjects[0].studentname}`;
            const subjectList = document.getElementById('subjectList');
            subjectList.innerHTML = '';

            subjects.forEach((subject, index) => {
                const card = document.createElement('div');
                card.className = 'subject-card';
                card.onclick = () => selectSubject(subject);

                const paymentStatus = checkCurrentMonthPayment(subject.payment, subject.monthly_fee);
                let statusClass = 'status-unpaid';
                if (paymentStatus.paid) {
                    statusClass = 'status-paid';
                } else if (paymentStatus.paidAmount > 0) {
                    statusClass = 'status-partial';
                }
                
                card.innerHTML = `
                    <span class="subject-number">${index + 1}</span>
                    <div class="subject-info">
                        <span class="subject-name">${subject.subject}</span>
                        <span class="subject-teacher">üë®‚Äçüè´ ${subject.teachername}</span>
                        <span class="subject-payment">
                            <span class="payment-status ${statusClass}">${paymentStatus.status}</span>
                        </span>
                    </div>
                `;

                subjectList.appendChild(card);
            });

            document.getElementById('subjectModal').classList.add('show');
        }

        function selectSubject(subject) {
            currentStudent = subject;
            document.getElementById('subjectModal').classList.remove('show');
            showStudentDetails();
        }

        function showStudentDetails() {
            const paymentStatus = checkCurrentMonthPayment(currentStudent.payment, currentStudent.monthly_fee);
            const balanceInfo = calculateBalance(currentStudent);
            
            document.getElementById('studentName').textContent = currentStudent.studentname;
            document.getElementById('subject').textContent = currentStudent.subject;
            document.getElementById('teacherName').textContent = currentStudent.teachername;
            
            if (currentStudent.monthly_fee === null || currentStudent.monthly_fee === undefined || currentStudent.monthly_fee === 0) {
                document.getElementById('monthlyFee').textContent = 'FREE CARD';
            } else {
                document.getElementById('monthlyFee').textContent = 'Rs. ' + currentStudent.monthly_fee;
            }

            let statusClass = 'status-unpaid';
            if (paymentStatus.paid) {
                statusClass = 'status-paid';
            } else if (paymentStatus.paidAmount > 0) {
                statusClass = 'status-partial';
            }
            document.getElementById('paymentStatus').innerHTML = `<span class="payment-status ${statusClass}">${paymentStatus.status}</span>`;

            const balanceAlert = document.getElementById('balanceAlert');
            if (balanceInfo.type === 'free') {
                balanceAlert.innerHTML = `
                    <div class="balance-alert positive">
                        <div style="font-size: 18px;">üéâ FREE CARD</div>
                        <div style="font-size: 14px; margin-top: 5px;">‡∂∏‡∑ô‡∂∏ ‡∑Å‡∑í‡∑Ç‡∑ä‚Äç‡∂∫‡∂∫‡∑è ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂ú‡∑è‡∑É‡∑ä‡∂≠‡∑î ‡∂Ö‡∂∫ ‡∂±‡∑ú‡∂ö‡∑ô‡∂ª‡∑ö</div>
                    </div>
                `;
            } else if (balanceInfo.balance < 0) {
                balanceAlert.innerHTML = `
                    <div class="balance-alert negative">
                        <div style="font-size: 18px;">‚ö†Ô∏è ‡∑Ñ‡∑í‡∂ü ‡∂∏‡∑î‡∂Ø‡∂Ω</div>
                        <div class="balance-amount">Rs. ${Math.abs(balanceInfo.balance).toFixed(2)}</div>
                        <div style="font-size: 14px; margin-top: 5px;">‡∂ú‡∑ô‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î ‡∂∏‡∑î‡∑Ö‡∑î ‡∂∏‡∑î‡∂Ø‡∂Ω</div>
                    </div>
                `;
            } else if (balanceInfo.balance > 0) {
                balanceAlert.innerHTML = `
                    <div class="balance-alert positive">
                        <div style="font-size: 18px;">‚úì ‡∂Ö‡∂≠‡∑í‡∂ª‡∑ö‡∂ö ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏</div>
                        <div class="balance-amount">Rs. ${balanceInfo.balance.toFixed(2)}</div>
                        <div style="font-size: 14px; margin-top: 5px;">‡∂Ö‡∂≠‡∑í‡∂ª‡∑ö‡∂ö‡∑Ä ‡∂ú‡∑ô‡∑Ä‡∑è ‡∂á‡∂≠‡∑í ‡∂∏‡∑î‡∂Ø‡∂Ω</div>
                    </div>
                `;
            } else {
                balanceAlert.innerHTML = `
                    <div class="balance-alert positive">
                        <div style="font-size: 18px;">‚úì ‡∑É‡∑í‡∂∫‡∂Ω‡∑ä‡∂Ω ‡∂±‡∑í‡∂ª‡∑Ä‡∑î‡∂Ω‡∑ä</div>
                        <div style="font-size: 14px; margin-top: 5px;">‡∑Ñ‡∑í‡∂ü‡∂∫‡∂ö‡∑ä ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠</div>
                    </div>
                `;
            }

            document.getElementById('studentModal').classList.add('show');
        }

        function showPaymentSection() {
            const paymentStatus = checkCurrentMonthPayment(currentStudent.payment, currentStudent.monthly_fee);
            
            document.getElementById('paymentSection').style.display = 'block';
            paymentAmount = '0';
            document.getElementById('paymentDisplay').textContent = '0';
        }

        function updatePaymentWarning() {
            const amount = parseFloat(paymentAmount);
            const monthlyFee = currentStudent.monthly_fee;
            const warningDiv = document.getElementById('paymentWarning');

            if (amount > monthlyFee) {
                const excess = amount - monthlyFee;
                warningDiv.innerHTML = `
                    <div class="payment-warning excess">
                        <strong>‚ö†Ô∏è ‡∂Ö‡∂≠‡∑í‡∂ª‡∑ö‡∂ö ‡∂∏‡∑î‡∂Ø‡∂Ω‡∂ö‡∑ä!</strong><br>
                        ‡∂∏‡∑è‡∑É‡∑í‡∂ö ‡∂ú‡∑è‡∑É‡∑ä‡∂≠‡∑î‡∑Ä: Rs. ${monthlyFee}<br>
                        ‡∂Ö‡∂≠‡∑í‡∂ª‡∑ö‡∂ö‡∑Ä: Rs. ${excess.toFixed(2)}
                    </div>
                `;
            } else if (amount < monthlyFee && amount > 0) {
                const shortage = monthlyFee - amount;
                warningDiv.innerHTML = `
                    <div class="payment-warning">
                        <strong>‚ö†Ô∏è ‡∂Ö‡∂©‡∑î ‡∂∏‡∑î‡∂Ø‡∂Ω‡∂ö‡∑ä!</strong><br>
                        ‡∂∏‡∑è‡∑É‡∑í‡∂ö ‡∂ú‡∑è‡∑É‡∑ä‡∂≠‡∑î‡∑Ä: Rs. ${monthlyFee}<br>
                        ‡∂Ö‡∂©‡∑î‡∑Ä‡∑ì‡∂∏: Rs. ${shortage.toFixed(2)}
                    </div>
                `;
            } else {
                warningDiv.innerHTML = '';
            }
        }

        async function processPayment() {
            const amount = parseFloat(paymentAmount);
            const monthlyFee = currentStudent.monthly_fee;

            if (amount === 0) {
                showErrorModal('‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂∏‡∑î‡∂Ø‡∂Ω‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±');
                return;
            }

            if (amount !== monthlyFee) {
                document.getElementById('paymentOptions').style.display = 'block';
                pendingPaymentData = { amount: amount };
                return;
            }

            await confirmPayment(amount);
        }

        function selectPaymentOption(option) {
            if (option === 'accept') {
                confirmPayment(pendingPaymentData.amount);
            } else {
                document.getElementById('paymentOptions').style.display = 'none';
                pendingPaymentData = null;
            }
        }

        async function confirmPayment(amount) {
            try {
                const now = new Date();
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const newPayment = `${now.getDate()}/${monthNames[now.getMonth()]}/${now.getFullYear()}-${amount}`;

                let updatedPayment = currentStudent.payment ? currentStudent.payment : '';
                if (updatedPayment) {
                    updatedPayment += ', ' + newPayment;
                } else {
                    updatedPayment = newPayment;
                }

                // T Report ‡∑É‡∑Ñ I Report update ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
                const tAmount = (amount * 0.8).toFixed(2);
                const iAmount = (amount * 0.2).toFixed(2);

                let updatedTreport = currentStudent.treport || '0';
                let updatedIreport = currentStudent.ireport || '0';

                const currentTreport = parseFloat(updatedTreport) || 0;
                const currentIreport = parseFloat(updatedIreport) || 0;

                updatedTreport = (currentTreport + parseFloat(tAmount)).toFixed(2);
                updatedIreport = (currentIreport + parseFloat(iAmount)).toFixed(2);

                const { error } = await supabase
                    .from('sipminireport')
                    .update({ 
                        payment: updatedPayment,
                        treport: updatedTreport,
                        ireport: updatedIreport
                    })
                    .eq('id', currentStudent.id);

                if (error) throw error;

                showSuccessModal(`‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∑Ä ‡∑É‡∂ß‡∑Ñ‡∂±‡∑ä ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì!\n‡∂∏‡∑î‡∂Ø‡∂Ω: Rs. ${amount}\nT Report: +Rs. ${tAmount}\nI Report: +Rs. ${iAmount}`);
                closeStudentModal();
            } catch (error) {
                showErrorModal('‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏ ‡∑É‡∂ß‡∑Ñ‡∂±‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö‡∂Ø‡∑ì ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‡∑É‡∑í‡∂Ø‡∑î‡∑Ä‡∑í‡∂∫', error);
            }
        }

        async function processDirectPayment() {
            showErrorModal('‡∑É‡∑ò‡∂¢‡∑î ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö‡∑í‡∂∫. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑Å‡∑í‡∑Ç‡∑ä‚Äç‡∂∫‡∂∫‡∑è ‡∂≠‡∑ù‡∂ª‡∑è ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏ ‡∑É‡∂ß‡∑Ñ‡∂±‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.');
            paymentMode = false;
            clearDisplay();
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal-overlay')) {
                if (event.target.id === 'subjectModal') {
                    closeSubjectModal();
                } else if (event.target.id === 'studentModal') {
                    closeStudentModal();
                } else if (event.target.id === 'errorModal') {
                    closeErrorModal();
                } else if (event.target.id === 'successModal') {
                    closeSuccessModal();
                }
            }
        }
    </script>
</body>
</html>
